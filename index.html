<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl">
  <title data-ice="title">API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/LeisureLink/write-ahead-log" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/log-index-file.js~LogIndexFile.html">LogIndexFile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/queue.js~Queue.html">Queue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/write-ahead-log.js~WriteAheadLog.html">WriteAheadLog</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><div data-ice="index" class="github-markdown"><h1 id="write-ahead-log-circle-ci-https-circleci-com-gh-leisurelink-write-ahead-log-svg-style-svg-https-circleci-com-gh-leisurelink-write-ahead-log-">write-ahead-log <a href="https://circleci.com/gh/LeisureLink/write-ahead-log"><img src="https://circleci.com/gh/LeisureLink/write-ahead-log.svg?style=svg" alt="Circle CI"></a></h1>
<p>An implementation of write-ahead logging (WAL) for nodejs.</p>
<h2 id="why">Why</h2>
<p>Write-ahead logging (WAL) is a building block used to improve automicity and durability in distributed systems. WAL improves these properties by providing persistent, sequenced storage for <em>Log Entries</em> as well as a record of which <em>Log Entries</em> have been committed. Since networks, software systems, and storage devices are unreliable, write-ahead logging also provides a mechanism to recover from failure.</p>
<h2 id="keep-it-simple">Keep it Simple</h2>
<p><code>wal</code> is a simple, abstract, write-ahead log. It won&apos;t provide much value unless you define a semantic for your application.</p>
<p>In our implementation, <em>Log Entries</em> are opaque binary values, defined and interpreted by you. Likewise, what it means to commit is also defined by you. For example, if you were to use <code>wal</code> in a data replication utility, <em>committed</em> may mean the <em>Log Entry</em> has been successfully distributed and acknowledged by your replicas.</p>
<p>We also define <em>Log Serial Number</em> (LSN) as an integer identfier numbered from 0 (zero) and incremented for each <em>Log Entry</em>. Our implementation guarantees that committed LSNs will never repeat or be re-issued.</p>
<p>We provide a simple recovery mechanism that visits each uncommitted entry, in order, and commits each, as long as the handler you supply indicates it is safe to do so by returning a truthy value; when your handler returns a falsy value, remaining uncommitted <em>Log Entries</em> are truncated. The LSN/index associated with those uncommitted <em>Log Entries</em> will be re-issued whan a subsequent <em>Log Entry</em> is made. This scheme enables our algorithm to be simple and fast. If your code requires guaranteed unique LSNs across restarts (a requirement for most database systems), we feel we have provided the collaboration semantics necessary for you to implement such guarantees on top of <code>wal</code> as an additional level of LSN indirection.</p>
<h2 id="install">Install</h2>
<pre><code class="lang-bash"><code class="source-code prettyprint">npm install wal</code>
</code></pre>
<h2 id="use">Use</h2>
<p><strong>es5</strong></p>
<pre><code class="lang-javascript"><code class="source-code prettyprint">var WriteAheadLog = require(&apos;wal&apos;).WriteAheadLog;</code>
</code></pre>
<p><strong>es6</strong></p>
<pre><code class="lang-javascript"><code class="source-code prettyprint">import { WriteAheadLog } from &apos;wal&apos;;</code>
</code></pre>
<h3 id="write-work-commit-cycle">Write-Work-Commit Cycle</h3>
<p>Write-ahead logging is accomplished through in a <em>write-work-commit</em> cycle.</p>
<ul>
<li>First &#x2014; <code>write</code> a log entry containing enough information to describe the activity and recover it if there is a subsequent failure,</li>
<li>Second &#x2014; perform the work,</li>
<li>Third &#x2014; when the activity is completed, <code>commit</code> the log entry; otherwise, if the activity cannot be completed, <code>truncate</code> the log at the log entry&apos;s LSN.</li>
</ul>
<pre><code class="lang-javascript"><code class="source-code prettyprint">const WriteAheadLog = require(&apos;wal&apos;);
const stdout = console.log.bind(console);
const stderr = console.error.bind(console);

function job(jobId) {
  // this is a simulation, you would probably do something more interesting.
  return new Promise((resolve) =&gt; {
    stdout(`performing job: ${jobId}`);
    setTimeout(() =&gt; {
      stdout(`done with job: ${jobId}`);
      resolve();
    }, 1000);
  });
}

const path = __filename + &apos;.wal&apos;;
const writable = true;

WriteAheadLog.openOrCreate({ path, writable })
  // usually when you open a log you&apos;ll want to run recovery in case of prior failure.
  //   here we&apos;re telling wal to truncate all uncommitted entries.
  .then(wal =&gt; wal.recover(false))
  .then(wal =&gt; {
    let committed = wal.commitHead;

    // We&apos;ll just use the LSN as our job number...
    let jobId = committed + 1;
    let data = new Buffer(`job #${jobId}\r\n`);

    // 1. Log some data; this data is opaque to the log...
    return wal.write(data)
      .then(lsn =&gt; {

        // 2. Do the actual work...
        return job(jobId).then(() =&gt; {

          // 3. Commit the log up to the LSN.
          return wal.commit(lsn)
            .then(() =&gt; {
              stdout(`committed job: ${jobId}`);
            });
        });
      })
      // perform a normal close.
      .then(() =&gt; wal.close());
  })
  .catch(err =&gt; stderr(&apos;&apos; + err));</code>
</code></pre>
<p>Chaos can occur at any time, for an illustration of simple failure and recovery, run the example script <a href="https://github.com/LeisureLink/write-ahead-log/blob/master/examples/chaotic-operations.js">chaotic-operations</a> and monitor what happens in both the log and index. This should give you a feel for how to scaffold on top of <code>wal</code>.</p>
<h3 id="sequencing">Sequencing</h3>
<p><code>wal</code> imposes strict ordering of commits; LSN/indexes must be committed in order. Obviously parallel operations, such as those waiting on IO will often complete out of order. It is the responsibility of the caller to ensure that out of order completion is resequenced before being applied to the log for commit.</p>
<h2 id="detailed-documentation-esdoc-">Detailed Documentation (esdoc)</h2>
<p>Detailed documentation is produced from code using <a href="https://esdoc.org/"><code>esdoc</code></a> and <a href="https://leisurelink.github.io/write-ahead-log/">is available online</a>.</p>
<p>To build the documentation locally, use <code>npm run docs</code> on the command line.</p>
<h2 id="module-api">Module API</h2>
<p><strong>Classes:</strong></p>
<ul>
<li><a href="#user-content-writeaheadlog-class"><code>WriteAheadLog</code></a> : <em>class</em> &#x2013; a simple write-ahead logging implementation.</li>
</ul>
<p><strong>Methods:</strong></p>
<ul>
<li><code>.create(options)</code> &#x2013; creates a write-ahead log using the specified options.</li>
<li><code>.open(options)</code> &#x2013; opens an existing a write-ahead log using the specified options.</li>
<li><code>.openOrCreate(options)</code> &#x2013; opens a specified write-ahead log if it exists; otherwise creates and opens the log.</li>
</ul>
<h4 id="writeaheadlog-class">WriteAheadLog Class</h4>
<p>An encapsulation of write-ahead logging behavior.</p>
<p><strong>Properties:</strong></p>
<ul>
<li><code>.name</code> &#x2013; the name of the log file (fully qualified path).</li>
<li><code>.index</code> &#x2013; the name of the log file&apos;s index (fully qualified path).</li>
<li><code>.writable</code> &#x2013; indicates whether the log was opened in a writable mode.</li>
<li><code>.size</code> &#x2013; the log files size in bytes.</li>
<li><code>.head</code> &#x2013; the log&apos;s next LSN/index (the write head).</li>
<li><code>.commitHead</code> &#x2013; the LSN/index of the most recently committed log entry.</li>
</ul>
<p><strong>Methods:</strong></p>
<ul>
<li><code>.close()</code> &#x2013; performs a normal close.</li>
<li><code>.commit(index)</code> &#x2013; commits the specified LSN/index.</li>
<li><code>.isCommitted(index)</code> &#x2013; determines if the specified LSN/index has been committed.</li>
<li><code>.read(index)</code> &#x2013; reads the log entry at the specified LSN/index.</li>
<li><code>.readRange(first, count)</code> &#x2013; streams the log entries starting at the first specified LSN/index until the specified number of log entries have been returned.</li>
<li><code>.recover(handler)</code> &#x2013; performs recovery logic against uncommitted log entries.</li>
<li><code>.truncate(from)</code> &#x2013; truncates uncommitted log entries starting at the specified LSN/index.</li>
<li><code>.write(data)</code> &#x2013; writes the specified data buffer next log entry.</li>
</ul>
<h2 id="license">License</h2>
<p><a href="https://github.com/LeisureLink/write-ahead-log/blob/master/LICENSE">MIT</a></p>
</div>
</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.7)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
